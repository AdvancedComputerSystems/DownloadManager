<!doctype html>
<html>
    <head>
        <title>ngEO Download Manager</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9" >
    </head>

	<body>
	    <div id="box_error_message"></div>
	    <div id="_tab_manager_" class="tabsContainer">
		    <ul id="_tab_manager_tabButtons" class="ulContainer">	
				<li><a href="#ngeo_if_LIST">ngEO Queue List for DM: {DM_ID}</a></li>
				<li><a href="#ngeo_if_LOGFILE">ngEO LOG FILE</a></li>
		    </ul>
	        <!-- wrap tab-panels in ui-layout-content div -->
		    <div id="_tab_manager_tabPanels" class="panelsContainer">	
			        <div id="ngeo_if_LIST">
			        <div class="col100 paddingObj">
		                
							<div class="col50L contentLeft">
								<form id="ngeo_if_downProductPathForm" class="addMargin">
								   <label for="down_path" class="labelright">Product Url:</label>
								   <input type="text" id="down_product_new_path" name="down_product_new_path" class="input200px">
								   <button keepData="false" type="submit" value="Start Download"  id="__btnProductDownload__" name="__btnProductDownload__" class="ui-button ui-widget ui-state-default ui-corner-all">
										<span class="fa fa-download"></span>
										<span>Start Download</span>
								   </button>
							   </form>
							</div>
		                     <div class="col50R contentRight">
			                  <div class="ngeo_grid_global_ops">
			               		  <button type="submit" extraForm="ngeo_if_resultForm" value="Edit Configuration"  id="__btnEditConf__" name="__btnEditConf__" class="ui-button ui-widget ui-state-default ui-corner-all" title="Edit download manager configuration">
									<span class="fa fa-cog"></span>
									<span>Edit Configuration</span>
								  </button>
			                      <button type="submit" extraForm="ngeo_if_resultForm" value="Clear terminated downloads"  id="__btnPurgeDB__" name="__btnPurgeDB__" class="ui-button ui-widget ui-state-default ui-corner-all" title="Remove completed, canceled and failed downloads from the list">
									<span class="fa fa-times-circle"></span>
									<span>Clear terminated downloads</span>
								  </button>
			                      <button type="submit" extraForm="ngeo_if_resultForm" value="Reset Statistics"  id="__btnResetStatistics__" name="__btnResetStatistics__" class="ui-button ui-widget ui-state-default ui-corner-all" title="Reset download manager statistics">
									<span class="fa fa-tasks"></span>
									<span>Reset statistics</span>
								  </button>
								  <button type="submit" onClick="window.open('../DownloadManager/NGEO_DM_ONLINE_MANUAL')" value="Help" class="ui-button ui-widget ui-state-default ui-corner-all">
									<span class="fa fa-question"></span>
									<span>Help</span>
								  </button>
								 
			                  </div>
			                  
		                    </div>
		                 </div>

		           <form id="ngeo_if_resultForm">
		           		<div class="wid99" >
		                   <button value='Select All'  role='checkbox' id="cb_ngeo_if_grid1" class='ui-button ui-widget ui-state-default ui-corner-all' type='button'/>
						   		<span class="fa fa-check"></span>
								<span>Select all</span>
						   </button>
	               	       <button value="Invert Selection"   type="button" class="ui-button ui-widget ui-state-default ui-corner-all" id="cbinv_ngeo_if_grid1" role="checkbox">
								<span class="fa fa-check-square"></span>
								<span>Invert Selection</span>
						   </button>
							<div class="ngeo_grid_item_ops">
								<button type="submit" extraForm="ngeo_if_resultForm" value="Pause"  id="__btnPause__" name="__btnPause__" class="ui-button ui-widget ui-state-default ui-corner-all" title="Pause selected downloads">
									<span class="fa fa-pause"></span>
									<span>Pause</span>
								</button>
								<button type="submit" extraForm="ngeo_if_resultForm" value="Resume"  id="__btnResume__" name="__btnResume__" class="ui-button ui-widget ui-state-default ui-corner-all" title="Resume selected downloads">
									<span class="fa fa-play"></span>
									<span>Resume</span>
								</button>
								<button type="submit" extraForm="ngeo_if_resultForm" value="Retry"  id="__btnRetry__" name="__btnRetry__" class="ui-button ui-widget ui-state-default ui-corner-all" title="Retry download of selected items">
									<span class="fa fa-refresh"></span>
									<span>Retry</span>
								</button>
								<button type="submit" extraForm="ngeo_if_resultForm" value="Cancel"  id="__btnStop__" name="__btnStop__" class="ui-button ui-widget ui-state-default ui-corner-all" title="Cancel download of selected items">
									<span class="fa fa-times"></span>
									<span>Cancel</span>
								</button>
								<button type="submit" extraForm="ngeo_if_resultForm" value="Change priority"  id="__btnChangePos__" name="__btnChangePos__" class="ui-button ui-widget ui-state-default ui-corner-all" title="Change download priority of selected items">
									<span class="fa fa-list-ol"></span>
									<span>Change priority</span>
								</button>
							</div>
	               	    </div>

	               		<div id="ngeo_if_grid_container_" class="fluid_style"> 
	                       <table id="ngeo_if_grid" width="100%" class="scroll" cellpadding="0" cellspacing="0"></table> 
	                       <div id="ngeo_if_gridpager" class="scroll" style="text-align:right"></div> 
	                  </div>
	              </form>
					<div class="col100 footer" style="margin-top: 20px" >
						<div id="serverData"></div>
						<div id="DM_running"></div>
						<div id="wsData" class="contData" >
						  <p class="acs_error"></p>
						</div>
					  </div>
					  
					 </div>
				</div>
				<div id="ngeo_if_LOGFILE">
				      <div class="logClass" id="logText"></div>
				</div>
				
		    </div>
	    </div>
		<form  method="POST" id="exportForm" enctype="multipart/form-data" action="" class='hidden'>
		   <input type="hidden" name="acs_sibAction" id="acs_sibAction" value="" />
		</form>     
	</body>
     
    <link href="webjars/ACSJavascriptLib/css/smoothness/jquery-ui-1.9.0.custom.css" type="text/css" rel="stylesheet">
    
    <link rel='stylesheet' href='webjars/ACSJavascriptLib/css/ui.jqgrid.css'>
     
    <link href="DownloadManager_javascript/css/font-awesome/css/font-awesome.min.css" type="text/css" rel="stylesheet">
    <link href="DownloadManager_javascript/css/layout-default-latest.css" type="text/css" rel="stylesheet">
    <link href="webjars/ACSJavascriptLib/css/acs_components.css" rel="stylesheet">
    
    <link href="DownloadManager_javascript/css/custom.css" type="text/css" rel="stylesheet">
    <script language="javascript" type="text/javascript">
   		var requireBasePath="webjars/ACSJavascriptLib/libs/";
	</script>
    <script src="webjars/ACSJavascriptLib/libs/require/require.js"></script>
    <script type="text/javascript" src="webjars/ACSJavascriptLib/main.js"></script>
    
    <script language="javascript" type="text/javascript">
		/*
           *Initialize HTML
           */          
          var startPayloadData={"classname":"nGEo","main_if":"ngEOManager"};         
          require(["jquery","acs_mainCanvas"], function($) {
          
			InterfaceModel = InterfaceModel.extend({        events:{
				"click input[type=reset]":"resetFormData",
				"click button":"clickInputSubmit",
				"click input[type=button]":"clickInputSubmit",
				"click input[type=submit]":"clickInputSubmit",
				"change select":"changeComboBox",
			}})

          var opt=$.toJSON({"goToServerEvent":false,
                             "callMethodAndSetProperties":[{objName:"cb_ngeo_if_grid",methodName:"trigger",args: "click" }]
           });
           
           var optinv=$.toJSON({"goToServerEvent":false,
               "callMethodAndSetProperties":[{objName:"cbinv_ngeo_if_grid",methodName:"trigger",args: "click" }]});
           
           
          // $.toJSON({tab_switch_notification:{ngeo_if_LOGFILE:true}})
            
			
			
			 var grid_config_str = localStorage.getItem("gridConfig");
			 var grid_config = grid_config_str ? JSON.parse(grid_config_str) : {columns: {}}
			 
		     var colModel = [
				{align:'left'
				  ,hidedlg:true
				  ,hidden:true
				  ,index:'id'
				  ,jsonmap:'gid'
				  ,key: true
				  ,label:'id'
				  ,name:'id'
				  , resizable:true  ,search:false  , sortable:true  , sorttype:'text' , width:30},
				  {align:'left'
				   ,hidedlg:true
				   ,hidden:true
				   ,index:'gid'
				   ,jsonmap:''
				   ,key: false
				   ,label:'gid'
				   ,name:'gid'
				  , resizable:true  ,search:false  , sortable:true  , sorttype:'text' , width:30},
				  {align:'left'
					,hidedlg:false
					,hidden: grid_config.columns['filename'] ? grid_config.columns['filename'].hidden : false
					,index:'filename'
					,jsonmap:''
					,key: false
					,label:'Product Name'
					,name:'filename'
					,resizable:true  ,search:true  
					,searchoptions: {sopt: ['cn']}
					,sortable:true
					,sorttype:'text'
					,width: grid_config.columns['filename'] ? grid_config.columns['filename'].width : 250
				  },                                   
				  { align:'left'
					,hidedlg:false
					,hidden: grid_config.columns['network'] ? grid_config.columns['network'].hidden : true
					,index:'network'
					,jsonmap:''
					,key: false
					,label:'Network'
					,name:'network'
				  , resizable:true
				  ,search:false
				  , sortable:true
				  , sorttype:'text'
				  , width: grid_config.columns['network'] ? grid_config.columns['network'].width : 50
				  },
				  { align:'right'
					,hidedlg:false
					,hidden: grid_config.columns['filesize'] ? grid_config.columns['filesize'].hidden : false
					,index:'filesize'
					,jsonmap:''
					,key: false
					,label:'Total Product Size'
					,name:'filesize'
				  , resizable:true  ,search:false  , sortable:true  , sorttype:'text'     ,
					width: grid_config.columns['filesize'] ? grid_config.columns['filesize'].width : 70},
				  { align:'left'
					,formatter:"progressbar"    ,hidedlg:false
					,hidden: grid_config.columns['progress'] ? grid_config.columns['progress'].hidden : false
					,index:'progress'
					,jsonmap:''
					,key: false
					,label:'%'
					,name:'progress'
				  , resizable:true  ,search:false  , sortable:true  , sorttype:'progressbar'     ,
					width: grid_config.columns['progress'] ? grid_config.columns['progress'].width : 80
				   },
				  { align:'left'
					,hidedlg:true
					,hidden:true
					,index:'filesource'
					,jsonmap:''
					,key: false
					,label:'DAR Source'
					,name:'filesource'
					,resizable:true  ,search:false  , sortable:true  , sorttype:'text' , width:150},
				  { align:'left'
					,formatter:"date"  ,formatoptions: { srcformat : 'Y-m-d H:i:s',newformat : 'd-m-Y H:i:s'}  ,hidedlg:false
					,hidden: grid_config.columns['ageNew'] ? grid_config.columns['ageNew'].hidden : false
					,index:'ageNew'
					,jsonmap:''
					,key: false
					,label:'Download Start'
					,name:'ageNew'
				  , resizable:true  
				   ,search:true  
				   ,sortable:true  
				   ,sorttype:'date'     
				   ,width: grid_config.columns['ageNew'] ? grid_config.columns['ageNew'].width : 60
				   ,stype:'date'
				   ,searchoptions: {sopt: ['ge'], dataInit:"datePick", showButtonPanel: true, dateFormat: "d-m-y"} },                      
				   { align:'left'
				   ,editoptions:{"value":{"0":"ALL","1":"RUNNING","2":"WAITING","3":"PAUSED","4":"IN_ERROR","5":"COMPLETED","6":"CANCELLED","7":"PROCESSING"}}
					,searchoptions:{"value":{"0":"ALL","1":"RUNNING","2":"WAITING","3":"PAUSED","4":"IN_ERROR","5":"COMPLETED","6":"CANCELLED","7":"PROCESSING"},"defaultValue":"0"}  
					,editable:true  
					,edittype:'text'    ,formatter:"select"    ,hidedlg:false
					,hidden: grid_config.columns['status_id'] ? grid_config.columns['status_id'].hidden : false
					,index:'status_id'
					,jsonmap:''
					,key: false
					,label:'Status'
					,name:'status_id'
				  , resizable:true  ,search:true  ,stype:'select', sortable:true, sorttype:'select',
					width: grid_config.columns['status_id'] ? grid_config.columns['status_id'].width : 60},
				  {align:'left'
					,hidedlg:false
					,hidden: grid_config.columns['error_message'] ? grid_config.columns['error_message'].hidden : false
					,index:'error_message'
					,jsonmap:''
					,key: false
					,label:'Error Message'
					,name:'error_message'
					,resizable:true  ,search:true  
					,searchoptions: {sopt: ['cn']}
					,sortable:true  , sorttype:'text'     ,
					width:grid_config.columns['error_message'] ? grid_config.columns['error_message'].width : 70},
				  {align:'left'
					,hidedlg:true
					,hidden:true
					,index:'selectedRow'
					,jsonmap:''
					,key: false
					,label:'selectedRow'
					,name:'selectedRow'
					,formatter:"rowHighlight"
					,formatoptions: { columnName : 'ALL'}
					,resizable:true  ,search:false  ,
					sortable:true  , sorttype:'text' ,
					width:30},
			 ]

			 for (var col in grid_config.columns) {
				for (var i=0; i < colModel.length; ++i) {
					if (colModel[i].name == col) {
						var new_pos = grid_config.columns[col].position;
						if (new_pos >= 0 && new_pos < colModel.length) {
							var c = colModel.splice(i, 1)[0];
							colModel.splice(new_pos, 0, c);
						}
						break;
					}
				}
			 }
			 
             var actionlistArr=[{"command":"INITIALIZE_INTERFACE","interfaceClass":"acs_sibMainWindow","interfaceId":"_tab_manager_","targetId":"_tab_manager_","parentId":"null",
                  "payloads":{ "libName":"jQuery", "objectType":"tabs", "options": $.toJSON({"setIntervalForPanel":{"ngeo_if_LOGFILE":{"time":5}}})}},
                   {"command":"ADDINTEFACE","interfaceClass":"ngeo_if_LIST","targetId":"ngeo_if_LIST","interfaceId":"ngeo_if_LIST","parentId":null,
                   "payloads":{"childrenOptions":{
                   "cb_ngeo_if_grid1":{"libName":"jQuery","objectType":"acs_button","options":opt},
                   "cbinv_ngeo_if_grid1":{"libName":"jQuery","objectType":"acs_button","options":optinv},
                   "logText":{"libName":"jQuery","objectType":"acs_tailer","options":$.toJSON({"maxNumberOfRow":500,parentScrollableObj:"body,html"})},
                   "ngeo_if_grid": { "libName":"jQuery", "objectType":"jqGrid", "options":
                    $.toJSON({sortable:true
                             ,jqGridContainerName:{"type":"tabs","containerName":"_tab_manager_","panelName":"ngeo_if_LIST","checkTabActive":true}
                             ,refreshTimerValue: (typeof(grid_config.refreshTimerValue) == "number") ? grid_config.refreshTimerValue : 1
                             ,showRefreshSlider:true
                             ,refreshSliderLabel:"(seconds)"
                             ,showCloseButton:false
                             ,height:'auto'                 
                             ,multiselect: true
                             ,multiselectWidth: 40
                             ,multiSelCheckBox:false
                             ,multiSelectButtonHidden:true                        
                             //,caption:'Table'
                             ,colNames:[]
                             ,colModel:colModel
                           ,pager:'#ngeo_if_gridpager'
                           ,sortname: grid_config.sortname || 'filesource'
						   ,sortorder: grid_config.sortorder || 'asc'
                           ,grouping:true
                           ,groupingView : { groupField : ['filesource'], groupColumnShow : [false], groupText : ['<b>{0} - {1} Product(s)</b>'] }
						   ,rowNum: grid_config.rowNum || 20
                                  
                    })//options toJson
                 }//grid
                }//childrenOptions
              }//paylods
            }];//interface-arraylist
      
             var gatewayURL=window.location.pathname.replace("index.jsp", "") + "DownloadsMonitorServlet";
              var mainCanvas=new CanvasView({"localInitialize":actionlistArr,"serverUrl":gatewayURL,"errorMessage":"DM Server not responding: please close this web page"});
              

              /*
              *acs_mainInteface
              */
              
              var grid=$('#'+'ngeo_if_grid');
              grid.jqGrid('navGrid','#ngeo_if_gridpager',{  
                          view:false,
                          del:false,
                          add:false,
                          edit:false,
                          search:false,
                          cloneToTop:false,
                          refresh:false
                      },{},{},{},{},{});
			  
			  
			  //modify table height on window resize
			  var onWindowResize = function() {
				   var max_height = $(window).height() - $(".ui-jqgrid .ui-jqgrid-bdiv").offset().top - 100;
				   grid.jqGrid('setGridHeight', max_height);
				   
				   $('#ngeo_if_LOGFILE').height($(window).height() - 90);
			  }
			  $(window).resize(onWindowResize);
			  //onWindowResize();
			  $("#_tab_manager_").on( "tabsactivate", onWindowResize);
			  
			  
			  //reset table scrollbar position at each refresh
			  var dp_fn = $.fn.jqGrid.dataProvider;
			  
			  $.fn.jqGrid.dataProvider = function(payload) {
				
				  var scroll_el = $(this).parents('.ui-jqgrid-bdiv')
				  var scroll_left = scroll_el.scrollLeft();
				  var scroll_top = scroll_el.scrollTop();
				  
				  var rv = dp_fn.apply(this, arguments);
				
				  scroll_el.scrollLeft(scroll_left);
				  scroll_el.scrollTop(scroll_top);
				  
				  onWindowResize();
				  
				  return rv;
			  }
			  
			  //save current grid configuration to localStorage
			  $(window).on('beforeunload',function(){
				var cols = grid.jqGrid('getGridParam', 'colModel');
				var columns = {}
				
				for (var i=1; i < cols.length - 1; ++i) {
					cols[i].position = i - 1;
					columns[cols[i].name] = cols[i];
				}
				
				var grid_config = {
					rowNum: parseInt(grid.jqGrid('getGridParam', 'rowNum')),
					columns: columns,
					refreshTimerValue: grid.jqGrid('getGridParam', 'refreshTimerValue'),
					sortname: grid.jqGrid('getGridParam', 'sortname'),
					sortorder: grid.jqGrid('getGridParam', 'sortorder')
				}
				localStorage.setItem("gridConfig", JSON.stringify(grid_config));
			  });
			  
			  __ON_LOAD__             
          });
          
          
   </script>
